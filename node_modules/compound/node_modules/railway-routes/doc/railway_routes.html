<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Map | API Docs</title>
        <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css" /><link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.css" />
        <style>
          .doc p {line-height: 21px; font-size: 16px}
          h2 .icon { margin-top: 7px !important;}
          h3 .icon { margin-top: 4px !important;}
          li {line-height: 21px;}
          .navbar .container { width: 940px; }
          .sidenav i {
            float: right;
            margin-top: 2px;
            margin-right: -6px;
          }
          .sidenav > li.nav-header {
            background-color: #eee;
          }
          .sidenav > li.nav-header,
          .sidenav > li > a {
            display: block;
            margin: 0 0 -1px;
            padding: 8px 14px;
            border: 1px solid #e5e5e5;
          }
          .sidenav > li.nav-header:first-child,
          .sidenav > li:first-child > a {
            -webkit-border-radius: 6px 6px 0 0;
            -moz-border-radius: 6px 6px 0 0;
            border-radius: 6px 6px 0 0;
          }
          .sidenav > li:last-child > a {
            -webkit-border-radius: 0 0 6px 6px;
            -moz-border-radius: 0 0 6px 6px;
            border-radius: 0 0 6px 6px;
          }

        </style>
    </head>
    <body>
      <div class="navbar">
        <div class="navbar-inner">
          <div class="container">
            <a class="brand" href="index.html">API Docs</a>
            <ul class="nav">
              <li class="active"><a href="railway_routes.html">Map</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="container">
        <div class="row">
          <div class="span3">
            <ul class="nav nav-list sidenav"><li class="nav-header">instance methods</li><li><a href="#instance/root"><i class="icon icon-eye-open"></i> root</a></li><li><a href="#instance/addPath"><i class="icon icon-eye-open"></i> addPath</a></li><li><a href="#instance/resources"><i class="icon icon-eye-open"></i> resources</a></li><li><a href="#instance/resource"><i class="icon icon-eye-open"></i> resource</a></li><li><a href="#instance/subroutes"><i class="icon icon-eye-open"></i> subroutes</a></li><li><a href="#instance/addRoutes"><i class="icon icon-eye-open"></i> addRoutes</a></li><li><a href="#instance/collection"><i class="icon icon-eye-open"></i> collection</a></li><li class="nav-header">helper methods</li><li><a href="#helper/camelize"><i class="icon icon-eye-close"></i> camelize</a></li></ul>
            &nbsp;
          </div>
          <div class="span9">
            <div class="hero-unit"><h1>Map</h1><div class="doc"><p>Routing map drawer. Encapsulates all logic required for drawing maps:<br />namespaces, resources, get, post, put, ..., all requests</p>

<p>@param <strong>Object</strong> app - RailwayJS or ExpressJS application<br />@param <strong>Function</strong> bridge - some bridge method that will server requests from<br />routing map to application</p>

<p>Usage example:</p>

<pre><code>var map = new require('railway-routes').Map(app, handler);
map.resources('posts');
map.namespace('admin', function (admin) {
   admin.resources('users');
});
</code></pre>

<p>Example <code>handler</code> loads controller and performs required action:</p>

<pre><code>function handler(ns, controller, action) {
    try {
        var ctlFile = './controllers/' + ns + controller + '_controller';
        var responseHandler =  require(ctlFile)[action];
    } catch(e) &lt;strong&gt;&lt;/strong&gt;
    return responseHandler || function (req, res) {
        res.send('Handler not found for ' + ns + controller + '#' + action);
    };
}
</code></pre></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:34" style="display: none; margin-top: 15px;"><code>function Map(app, bridge) {
    if (!(this instanceof Map)) return new Map(app, bridge);
    this.app = app;
    this.bridge = bridge;
    this.paths = [];
    this.ns = '';
    // wtf???
    this.globPath = '/';
    this.pathTo = new RoutesCollection;
    this.dump = [];
    this.middlewareStack = [];
    this.camelCaseHelperNames = false;
    this.nestedRoutesOnCollection = false;
}
</code></pre></div><hr/><a href="#instance" class="btn btn-info btn-large">Instance methods</a> <a href="#helper" class="btn btn-inverse btn-large">Helper methods</a> </div><a name="instance"></a><div class="page-header"><h2>Map - instance methods</h2></div><ul class="nav nav-pills"><li><a href="#instance/root">root</a></li><li><a href="#instance/addPath">addPath</a></li><li><a href="#instance/resources">resources</a></li><li><a href="#instance/resource">resource</a></li><li><a href="#instance/subroutes">subroutes</a></li><li><a href="#instance/addRoutes">addRoutes</a></li><li><a href="#instance/collection">collection</a></li></ul><div class="method"><a name="instance/root"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.root</h2><blockquote>Declared as <code>function (handler, middleware, options) </code></blockquote><div class="doc"><p>Map root url</p></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:95" style="display: none; margin-top: 15px;"><code>function (handler, middleware, options) {
    this.get('/', handler, middleware, options);
};
</code></pre></div><hr/></div><div class="method"><a name="instance/addPath"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.addPath</h2><blockquote>Declared as <code>function (templatePath, action, helperName) </code></blockquote><div class="doc"><p>Add path helper to <code>pathTo</code> collection</p></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:186" style="display: none; margin-top: 15px;"><code>function (templatePath, action, helperName) {
    var app = this.app;

    if (templatePath instanceof RegExp) {
        // TODO: think about adding to `path_to` routes by reg ex
        return;
    }
    var paramNames = [];
    var paramsLength = templatePath.match(/\/:\w*/g);
    if (paramsLength) {
        paramNames = paramsLength.map(function (p) {
            return p.substr(2);
        });
    }
    paramsLength = paramsLength === null ? 0 : paramsLength.length;
    var optionalParamsLength = templatePath.match(/\/:\w*\?/);
    if (optionalParamsLength)
    optionalParamsLength = optionalParamsLength ? optionalParamsLength.length : 0;
    helperName = helperName || this.urlHelperName(templatePath, action);

    // already defined? not need to redefine
    if (helperName in this.pathTo) return;

    if (this.camelCaseHelperNames && helperName.match(/_/)) {
        helperName = camelize(helperName);
    }

    this.pathTo[helperName] = function (objParam) {
        // TODO: thing about removing or rewriting it
        // if (arguments.length &lt; (paramsLength - optionalParamsLength) || ) {
            // return '';
            // throw new Error('Expected at least ' + paramsLength + ' params for build path ' + templatePath + ' but only ' + arguments.length + ' passed');
        // }
        var value, arg, path = templatePath;
        for (var i = 0; i &lt; paramsLength; i += 1) {
            value = null;
            arg = arguments[i];
            if (arg && typeof arg.to_param == 'function') {
                value = arg.to_param();
            } else if (arg && typeof arg === 'object' && arg.id && arg.constructor.name !== 'ObjectID') {
                value = arg.id;
            } else if (paramNames[i] && objParam && objParam[paramNames[i]]) {
                value = objParam[paramNames[i]];
            } else {
                value = arg && arg.toString ? arg.toString() : arg;
            }
            var matchOptional = path.match(/:(\w*\??)/);
            if (matchOptional && matchOptional[1].substr(-1) === '?' && !value) {
                path = path.replace(/\/:\w*\??/, '');
            } else {
                path = path.replace(/:\w*\??/, '' + value);
            }
        }
        if (arguments[paramsLength]) {
            var query = [];
            for (var key in arguments[paramsLength]) {
                if (key == 'format' && path.match(/\.:format\??$/)) {
                    path = path.replace(/\.:format\??$/, '.' + arguments[paramsLength][key]);
                } else {
                    query.push(key + '=' + arguments[paramsLength][key]);
                }
            }
            if (query.length) {
                path += '?' + query.join('&');
            }
        }
        path = path.replace(/\.:format\?/, '');
        // add ability to hook url handling via app
        if (this.app.hooks && this.app.hooks.path) {
            this.app.hooks.path.forEach(function (hook) {
                path = hook(path);
            });
        }
        var appprefix = '';
        if (app.path) {
            appprefix = app.path();
        } else {
            appprefix = app.set('basepath') || '';
        }
        return appprefix + path;
    }.bind(this);
    this.pathTo[helperName].toString = function () {
        return this.pathTo[helperName]();
    }.bind(this);
}
</code></pre></div><hr/></div><div class="method"><a name="instance/resources"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.resources</h2><blockquote>Declared as <code>function (name, params, actions) </code></blockquote><div class="doc"><p>Resources mapper</p>

<p>Example</p>

<pre><code>map.resources('users');
</code></pre></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:280" style="display: none; margin-top: 15px;"><code>function (name, params, actions) {
    var self = this;
    // params are optional
    params = params || {};

    // if params arg omitted, second arg may be `actions`
    if (typeof params == 'function') {
        actions = params;
        params = {};
    }
    
    params.appendFormat = ('appendFormat' in params) ? params.appendFormat : true;

    // If resource uses the path param, it's subroutes should be
    // prefixed by path, not the resource's name
    // i.e.:
    // map.resource('users', {path: ':username'}, function(user) {
    //   user.resources('posts);
    // });
    // 
    // /:username/posts.:format?
    // /:username/posts/new.:format?
    // etc.
    var prefix = params.path ? params.path : name;

    // we have bunch of actions here, will create routes for them
    var activeRoutes = getActiveRoutes(params);
    // but first, create subroutes
    if (typeof actions == 'function') {
        var oldResource = this.latestResource;
        this.latestResource = name;
        if (params.singleton) {
            this.subroutes(prefix, actions); // singletons don't need to specify an id
        } else {
            this.subroutes(prefix + '/:' + (singularize(name) || name) + '_id', actions);
        }
        this.latestResource = oldResource;
    }

    // now let's walk through action routes
    for (var action in activeRoutes) {
        (function (action) {
            var route = activeRoutes[action].split(/\s+/);
            var method = route[0];
            var path = route[1];

            // append format
            if (params.appendFormat !== false) {
              if (path == '/') {
                  path = '.:format?';
              } else {
                  path += '.:format?';
              }
            }

            // middleware logic (backward compatibility)
            var middlewareExcept = params.middlewareExcept, skipMiddleware = false;
            if (middlewareExcept) {
                if (typeof middlewareExcept == 'string') {
                    middlewareExcept = [middlewareExcept];
                }
                middlewareExcept.forEach(function (a) {
                    if (a == action) {
                        skipMiddleware = true;
                    }
                });
            }

            // params.path setting allows to override common path component
            var effectivePath = (params.path || name) + path;

            var controller = params.controller || name;

            // and call map.{get|post|update|delete}
            // with the path, controller, middleware and options
            this[method.toLowerCase()].call(
                this,
                effectivePath,
                controller + '#' + action,
                skipMiddleware ? [] : params.middleware,
                getParams(action, params)
            );
        }.bind(this))(action);
    }

    return this;

    // calculate set of routes based on params.only and params.except
    function getActiveRoutes(params) {
        var activeRoutes = {},
            availableRoutes =
            {   'index':   'GET     /'
            ,   'create':  'POST    /'
            ,   'new':     'GET     /new'
            ,   'edit':    'GET     /:id/edit'
            ,   'destroy': 'DELETE  /:id'
            ,   'update':  'PUT     /:id'
            ,   'show':    'GET     /:id'
            },
            availableRoutesSingleton = 
            {   'show':    'GET     /'
            ,   'create':  'POST    /'
            ,   'new':     'GET     /new'
            ,   'edit':    'GET     /edit'
            ,   'destroy': 'DELETE  /'
            ,   'update':  'PUT     /'
            };

        if (params.singleton)
          availableRoutes = availableRoutesSingleton;

        // 1. only
        if (params.only) {
            if (typeof params.only == 'string') {
                params.only = [params.only];
            }
            params.only.forEach(function (action) {
                if (action in availableRoutes) {
                    activeRoutes[action] = availableRoutes[action];
                }
            });
        }
        // 2. except
        else if (params.except) {
            if (typeof params.except == 'string') {
                params.except = [params.except];
            }
            for (var action in availableRoutes) {
                if (params.except.indexOf(action) == -1) {
                    activeRoutes[action] = availableRoutes[action];
                }
            }
        }
        // 3. all
        else {
            for (var action in availableRoutes) {
                activeRoutes[action] = availableRoutes[action];
            }
        }
        return activeRoutes;
    }

    function getParams(action, params) {
        var p = {};
        var plural = action === 'index' || action === 'create';
        if (params.as) {
            p.as = plural ? params.as : (singularize(params.as) || params.as);
            p.as = self.urlHelperName(self.globPath + p.as);
            if (action === 'new' || action === 'edit') {
                p.as = action + '_' + p.as;
            }
            if (params.suffix && !plural) {
                p.as = p.as + '_' + (singularize(params.suffix) || params.suffix);
            }
        }
        if (params.path && !p.as) {
            var aname = plural ? name : (singularize(name) || name);
            aname = self.urlHelperName(self.globPath + aname);
            p.as = action === 'new' || action === 'edit' ? action + '_' + aname : aname;
        }
        if ('state' in params) {
            p.state = params.state;
        }
        return p;
    }
};
</code></pre></div><hr/></div><div class="method"><a name="instance/resource"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.resource</h2><blockquote>Declared as <code>function(name, params, actions) </code></blockquote><div class="doc"></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:447" style="display: none; margin-top: 15px;"><code>function(name, params, actions) {
    var self = this;
    // params are optional
    params = params || {};
    // if params arg omitted, second arg may be `actions`
    if (typeof params == 'function') {
        actions = params;
        params = {};
    }
    params.singleton = true;
    return this.resources(name, params, actions);
}
</code></pre></div><hr/></div><div class="method"><a name="instance/subroutes"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.subroutes</h2><blockquote>Declared as <code>function (name, subroutes) </code></blockquote><div class="doc"></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:494" style="display: none; margin-top: 15px;"><code>function (name, subroutes) {
    // store previous ns
    var oldGlobPath = this.globPath;
    // add new ns to old (ensure tail slash present)
    this.globPath = oldGlobPath + name.replace(/\/$/, '') + '/';
    subroutes(this);
    this.globPath = oldGlobPath;
};
</code></pre></div><hr/></div><div class="method"><a name="instance/addRoutes"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.addRoutes</h2><blockquote>Declared as <code>function (path, customBridge) </code></blockquote><div class="doc"><p>Load routing map from module at <code>path</code>. Module should have <code>routes</code> function<br />or export single function:</p>

<pre><code>module.exports = function (map) {
    map.resources('books');
});
</code></pre></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:511" style="display: none; margin-top: 15px;"><code>function (path, customBridge) {
    var bridge;
    var map = this;
    var routes = require(path);
    routes = routes.routes || routes;
    if (typeof routes !== 'function') {
        throw new Error('Routes is not defined in ' + path);
    }
    // temporarily change bridge
    if (customBridge) {
        bridge = map.bridge;
        map.bridge = customBridge;
    }
    var r = routes(map);
    if (customBridge) {
        map.bridge = bridge;
    }
    return r;
};
</code></pre></div><hr/></div><div class="method"><a name="instance/collection"></a><h2><i class="icon icon-eye-open"></i> <span style="color: grey">Map.</span><span style="color: green">prototype</span>.collection</h2><blockquote>Declared as <code>function (actions) </code></blockquote><div class="doc"><p>Syntax sugar for nested routes for collection<br />this method only can be used in context of nested actions</p>

<p>Example:</p>

<pre><code>map.resources('posts', function (post) {
    post.collection(function (posts) {
        posts.del('destroyAll', 'posts#destroyAll');
    });
});
</code></pre></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:543" style="display: none; margin-top: 15px;"><code>function (actions) {
    this.nestedRoutesOnCollection = true;
    actions(this);
    this.nestedRoutesOnCollection = false;
    return this;
};
</code></pre></div><hr/></div><a name="helper"></a><div class="page-header"><h2>Map - helper methods</h2></div><ul class="nav nav-pills"><li><a href="#helper/camelize">camelize</a></li></ul><div class="method"><a name="helper/camelize"></a><h2><i class="icon icon-eye-close"></i> <span style="color: grey"></span>camelize</h2><blockquote>Declared as <code>function camelize(str) </code></blockquote><div class="doc"></div><div class="source-code"><a class="btn btn-small" onclick="$(this).parent().find('pre').toggle()">Source code</a><pre class="prettyprint linenums:550" style="display: none; margin-top: 15px;"><code>function camelize(str) {
    if (!str) return str;
    return str.replace(/_+(.)/g, function (all, first) {
        return first.toUpperCase();
    });
}
</code></pre></div><hr/></div>
          </div>
        </div>
    </body>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script><script src="http://twitter.github.com/bootstrap/assets/js/google-code-prettify/prettify.js"></script><script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
    <script>
      window.prettyPrint && prettyPrint()
    </script>
</html>
